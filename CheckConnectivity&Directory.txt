#!/bin/bash
# ***********************************
# Created by Ninad Adhav            *
# Email ninad.adhav@oracle.com      *
# ***********************************

LogMsg(){
        local log=$1
        local msg=$2
        local pid=$$
        local now=$(date +'%s')
        local stamp=$(date --date "@${now}" +'%Y/%m/%d %H:%M:%S')
        echo "${stamp}-${pid}-${msg}" >>$log
}

CreateLog(){
        file=$1
        [ ! -e ${file} ] && touch $file
        sudo chmod a+rw $file
        sudo chown opc:opc $file
}


input_csv(){
echo Enter the path to the Input CSV File...
read -p 'Input Path to the file and press Enter : ' inputpath
if [[ -f $inputpath ]]
   then
       LogMsg $LOGFILE "File found...proceeding to Tar Process"
   else
       echo CSV File does not exist at $inputpath ....Exiting !!!
       LogMsg $LOGFILE "CSV File does not exist at $inputpath ....Exiting !!!"
       echo
       exit 1
fi
sed -n '2,$p' <$inputpath > parsed_file.csv
LogMsg $LOGFILE "Installing Dos2unix Package for File conversion"
in=$(sudo yum install -q -y dos2unix && dos2unix -q parsed_file.csv)
LogMsg $LOGFILE "'$in'"
echo
}

soarvm_directory{
if [[ -d $mpoint2 ]];
  then
     LogMsg $LOGFILE "Directory $mpoint2 found on SOAR VM...proceeding"
  else
     echo SOURCE NAS DIRECTORY DOES NOT EXIST ON SOAR VM...EXITING !!
     LogMsg $LOGFILE "NAS DIRECTORY $mpoint2 DOES NOT EXIST on SOAR VM...EXITING !!"
     exit 1
fi
}

source_connectivity(){
echo "Checking Source Server Connectivity..."
echo
for f in $(cat parsed_file.csv | cut -d"," -f2);
  do
    status=$(ssh -q -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=5 -i /home/opc/keys/ocs_key opc@$f echo ok 2>&1)
    if [[ $status == ok ]] ; then
          echo Connectivity Established to $f !!
          echo "Checking if $mpoint2 is present on $f"
          ssh -n -q -o StrictHostKeyChecking=no -i /home/opc/keys/ocs_key opc@$f "
          if [[ -d $mpoint2 ]]; then
              echo Directory is Present at $f
          else
              echo Directory $mpoint2 DOES NOT EXIST on Server $f Please Check and re-run the code!!!
          fi" 1>source_servers.log

          source_out=`cat /home/opc/source_servers.log`
          if [[ "${source_out}" == *"DOES NOT EXIST"* ]]; then
              echo "*********************************************************************************************************"
              echo "ERROR FOUND ------------> Directory $mpoint2 DOES NOT EXIST on Server $f"
              echo "*********************************************************************************************************"
              echo
          else
              echo "Directory $mpoint2 present"
              echo
          fi

    elif [[ $status == "Permission denied"* ]] ; then
       echo "Establishing Connection to $f"
       echo "*************************************************************************************************************************"
       echo ERROR --------> Permission Denied...Please check the ssh configuration of the Source Server $f
       echo
       echo "Cannot determine if $mpoint2 is present on Source $f. Fix connectivity issue and run again "
       echo "*************************************************************************************************************************"
    else
       echo "Establishing Connection to $f"
       echo "*********************************************************************************************************************************************"
       echo ERROR --------> Incorrect Authentication..Please check the IP Address and Key provided in the path to the Source Server $f.
       echo
       echo "Cannot determine if $mpoint2 is present on Source $f . Fix connectivity issue and run again "
       echo "*********************************************************************************************************************************************"
    fi >>final.log
    sleep 1
   done
   cat final.log
   final=`cat /home/opc/final.log`
   if [[ "${final}" == *"DOES NOT EXIST"* ]]; then
              echo ____________________________________________________________________________________________
              echo
              echo "One or more Errors have been found and highlighted above...Please fix and rerun...EXITING"
              echo ____________________________________________________________________________________________
              echo
              exit 1
   else
              echo _________________________________________________________
              echo
              echo "NO ERRORS FOUND.........PROCEEDING"
              echo _________________________________________________________
   fi

}

target_connectivity(){
echo "Checking Target Server Connectivity..."
echo
for g in $(cat parsed_file.csv | cut -d"," -f1);
  do
    status1=$(ssh -q -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=5 -i /home/opc/keys/ocs_key opc@$g echo ok 2>&1)
    if [[ $status1 == ok ]] ; then
          echo Connectivity Established to $g !!
          echo "Checking if $mountpoint2 is present on $g"
          ssh -n -q -o StrictHostKeyChecking=no -i /home/opc/keys/ocs_key opc@$g "
          if [[ -d $mountpoint2 ]]; then
              echo Directory is Present at $g
          else
              echo Directory $mountpoint2 DOES NOT EXIST on Server $g Please Check and re-run the code!!!
          fi" 1>target_servers.log

          target_out=`cat /home/opc/target_servers.log`
          if [[ "${target_out}" == *"DOES NOT EXIST"* ]]; then
              echo "*********************************************************************************************************"
              echo "ERROR FOUND ------------> Directory $mountpoint2 DOES NOT EXIST on Server $g"
              echo "*********************************************************************************************************"
              echo
          else
              echo "Directory $mountpoint2 present"
              echo
          fi

    elif [[ $status1 == "Permission denied"* ]] ; then
       echo "Establishing Connection to $g"
       echo "*************************************************************************************************************************"
       echo ERROR ---------> Permission Denied...Please check the ssh configuration of the Target Server $g
       echo
       echo "Cannot determine if $mountpoint2 is present on Source $g. Fix connectivity issue and run again "
       echo "*************************************************************************************************************************"
    else
       echo "*************************************************************************************************************************"
       echo ERROR ----------> Incorrect Authentication..Please check the IP Address and Key provided in the path to the Target Server $g.
       echo 
       echo "Cannot determine if $mountpoint2 is present on Source $g . Fix connectivity issue and run again "
       echo "*************************************************************************************************************************"
    fi >>final1.log
    sleep 1
   done
   cat final1.log
   final1=`cat /home/opc/final1.log`
   if [[ "${final1}" == *"DOES NOT EXIST"* ]]; then
              echo ____________________________________________________________________________________________
              echo
              echo "One or more Errors have been found and highlighted above...Please fix and rerun...EXITING"
              echo ____________________________________________________________________________________________
              echo
              exit 1
   else
              echo _________________________________________________________
              echo
              echo "NO ERRORS FOUND.........PROCEEDING"
              echo _________________________________________________________
   fi

}

tar1(){
x=(`cat parsed_file.csv | cut -d"," -f2`)
x1=${#x[@]}
y=(`cat parsed_file.csv | cut -d"," -f4- | sed -e "s/,/-/g"`)
y1=${#y[@]}
z=(`cat /home/opc/parsed_file.csv | cut -d"," -f2-3 | sed -e "s/ /-/g" | sed -e "s/,/-/g"`)
z1=${#z[@]}
for ((i=0,j=0,k=0 ; i<${x1},j<${y1},k<${z1} ; i++,j++,k++));
    do
       test=$(echo "${y[$i]}" | sed -e "s/-/ /g")
       echo Current Directories being Archived and Compressed are : $test
       LogMsg $LOGFILE "-----------------Connecting to Source ${x[$i]} --------------"
       tar11=$(ssh -n -q -o StrictHostKeyChecking=no -i /home/opc/keys/ocs_key opc@${x[$i]} "cd $mountpoint2;
       sudo tar -cvpPf ${z[$i]}.tar.gz --totals $test && echo; bash") &
       echo
       LogMsg $LOGFILE "'$tar11'"
       LogMsg $LOGFILE "----------------- TAR PROCESS COMPLETE FOR $test --------------"
    done
}

upload2obj(){
cd $mountpoint2
for file in `ls $mountpoint2`;
  do
      LogMsg $LOGFILE "Starting Upload of File $file to the OCS_MIgrations Bucket on OCI Object Storage"
      upload=$(oci os object put -bn OCS_Migrations --file $file) &
      echo "$upload"
      LogMsg $LOGFILE "'$upload'"
      LogMsg $LOGFILE "File $file has been uploaded to the OCS_MIgrations Bucket on OCI Object Storage"
  done
}

downloadfromobjstorage(){
for ipaddress in $(cat parsed_file.csv | awk 'NR==1 {print $1}' | cut -d"," -f1)
    do
        LogMsg $LOGFILE "----------------- CONNECTING TO TARGET $ipaddress --------------"
        LogMsg $LOGFILE "----------------- DOWNLOADING FILES FROM OBJECT STORAGE --------------"
        dwnldobj=$(ssh -n -q -o StrictHostKeyChecking=no -i /home/opc/keys/ocs_key opc@$ipaddress "
            oci os object bulk-download -bn OCS_Migrations --download-dir $mpoint2 ") &
        echo "'$dwnldobj'"
        LogMsg $LOGFILE "'$dwnldobj'"
        LogMsg $LOGFILE "----------------- DOWNLOAD PROCESS COMPLETE --------------"
}

untar(){
cd /home/opc
a=(`cat parsed_file.csv | cut -d"," -f1`)
a1=${#a[@]}
b=(`cat /home/opc/parsed_file.csv | cut -d"," -f2-3 | sed -e "s/ /-/g" | sed -e "s/,/-/g"`)
b1=${#b[@]}
for ((u=0,v=0 ; u<${a1},v<${b1} ; u++,v++));
    do
       LogMsg $LOGFILE "----------------- CONNECTING TO TARGET ${a[$u]} --------------"
       LogMsg $LOGFILE "----------------- DOWNLOADING ${b[$u]} FROM OBJECT STORAGE --------------"
       untar11=$(ssh -n -q -o StrictHostKeyChecking=no -i /home/opc/keys/ocs_key opc@${a[$u]} "
           cd $mpoint2
           sudo tar -xpPf ${b[$u]}.tar.gz
          fi ") &
       LogMsg $LOGFILE "'$untar11'"
       LogMsg $LOGFILE "----------------- UNTAR PROCESS COMPLETE FOR $test --------------"
   done
}

LOGFILE=/var/log/psft-$HOSTNAME.log
CreateLog ${LOGFILE}
input_csv
rm -rf /home/opc/source_servers.log /home/opc/target_servers.log /home/opc/final.log /home/opc/final1.log

read -p 'Enter Mount Point Directory Path for Source Servers: ' mpoint
echo
mpoint1=$mpoint
mpoint2=${mpoint1%/}

read -p 'Enter Mount Point Directory Path for Target Servers: ' mountpoint
echo
mountpoint1=$mountpoint
mountpoint2=${mountpoint1%/}


soarvm_directory
sleep1
echo

source_connectivity
sleep 1
echo

target_connectivity
sleep 1

tar1
upload2obj
downloadfromobjstorage
untar
echo
echo ___________________________________
echo COMPLETED
echo ___________________________________
echo
